<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Hiệu Suất - BV Ung Bướu CS2</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --bv-blue: #00529b; --bv-green: #2ecc71; }
        
        body { background-color: #f4f7f9; font-family: "Times New Roman", Times, serif; padding: 20px; color: #333; }
        
        .report-card { 
            max-width: 1000px; margin: auto; background: white; 
            border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
            padding: 40px; border-top: 10px solid var(--bv-blue); 
        }

        .hospital-name { color: var(--bv-blue); font-weight: bold; font-size: 1.4rem; margin: 0; text-transform: uppercase; }
        .dept-name { color: var(--bv-green); font-weight: bold; font-size: 1.1rem; margin-top: 5px; }

        .report-title { 
            text-align: center; font-weight: bold; margin: 30px 0; 
            font-size: 1.8rem; text-transform: uppercase; color: #000;
        }

        .table { border: 1.5px solid #000; font-size: 1.1rem; }
        .table thead th { background-color: #f8f9fa; color: #000; border: 1px solid #000; padding: 12px; text-align: center; }
        .table td { border: 1px solid #000; vertical-align: middle; padding: 8px; }
        
        .input-number { 
            width: 100%; border: none; text-align: right; 
            font-weight: bold; background: #fdfdfd; font-size: 1.4rem; 
            color: var(--bv-blue); padding: 5px 10px; border-radius: 6px;
        }
        .input-number:focus { outline: none; background: #fffde7; }

        /* Vùng 7 ô mini - Đã điều chỉnh dài ra vừa khung xanh */
        #specialInputArea { 
            background: rgba(0, 82, 155, 0.05); padding: 20px; 
            border-radius: 10px; margin-bottom: 25px; border: 2px solid var(--bv-blue);
        }
        .mini-input-group { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); /* Chia đều 7 cột bằng nhau */
            gap: 12px; /* Khoảng cách giữa các ô */
        }
        .mini-input { 
            width: 100% !important; /* Dài ra chiếm hết diện tích ô lưới */
            height: 50px !important; 
            font-size: 1.4rem !important; 
            font-weight: bold; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            text-align: center;
            background: white;
            transition: all 0.2s;
        }
        .mini-input:focus { border-color: var(--bv-blue); outline: none; background: #fff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .control-bar { margin-bottom: 20px; }
        #datePicker { font-size: 1rem; padding: 5px 15px; border-radius: 20px; border: 2px solid var(--bv-blue); height: 40px; }
        #passInput { border-radius: 20px; height: 40px; font-size: 0.9rem; }
        .btn-success { border-radius: 20px; padding: 8px 25px; font-weight: bold; }

        .footer-date { margin-top: 40px; text-align: right; font-style: italic; font-size: 1.2rem; }
        #totalValue { font-weight: bold; color: #d63031; font-size: 1.7rem; }

        @media print { .no-print { display: none !important; } .report-card { box-shadow: none; border: none; width: 100%; padding: 0; } }
    </style>
</head>
<body>

<div class="report-card">
    <div class="hospital-brand">
        <p class="hospital-name">SỞ Y TẾ TP. HỒ CHÍ MINH</p>
        <p class="hospital-name">BỆNH VIỆN UNG BƯỚU - CS2</p>
        <p class="dept-name">KHOA XÉT NGHIỆM</p>
    </div>

    <h3 class="report-title">BẢNG BÁO CÁO HIỆU SUẤT XÉT NGHIỆM</h3>

    <div class="control-bar no-print d-flex justify-content-between align-items-center">
        <input type="date" id="datePicker" onchange="loadData()" class="form-control w-auto">
        <div id="authArea"><input type="password" id="passInput" placeholder="Mật khẩu" class="form-control" style="width:130px;"></div>
        <div id="editArea" style="display: none;">
            <button onclick="saveData()" class="btn btn-success shadow-sm">LƯU BÁO CÁO</button>
            <button onclick="lock()" class="btn btn-outline-secondary ms-2">Đóng</button>
        </div>
    </div>

    <div id="specialInputArea" class="no-print" style="display: none;">
        <div class="mini-input-group">
            <input type="number" class="mini-input" id="mini-1" onkeyup="jumpAndSelect('mini-', 1, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="1">
            <input type="number" class="mini-input" id="mini-2" onkeyup="jumpAndSelect('mini-', 2, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="2">
            <input type="number" class="mini-input" id="mini-3" onkeyup="jumpAndSelect('mini-', 3, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="3">
            <input type="number" class="mini-input" id="mini-4" onkeyup="jumpAndSelect('mini-', 4, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="4">
            <input type="number" class="mini-input" id="mini-5" onkeyup="jumpAndSelect('mini-', 5, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="5">
            <input type="number" class="mini-input" id="mini-6" onkeyup="jumpAndSelect('mini-', 6, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="6">
            <input type="number" class="mini-input" id="mini-7" onkeyup="jumpAndSelect('mini-', 7, 7)" oninput="sumSpecial()" onfocus="forceSelect(this)" placeholder="7">
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th width="5%">STT</th>
                <th width="12%">MÃ MÁY</th>
                <th width="48%">TÊN HỆ THỐNG / THIẾT BỊ</th>
                <th width="20%">MODEL</th>
                <th width="15%">SỐ LƯỢNG</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr style="background: #f8f9fa;">
                <td colspan="4" class="text-end px-4 fw-bold">TỔNG CỘNG</td>
                <td id="totalValue" class="text-end px-3">0</td>
            </tr>
        </tfoot>
    </table>

    <div class="footer-date">Ngày <span id="dDay">..</span> tháng <span id="dMonth">..</span> năm <span id="dYear">20..</span></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let isEditing = false;
    let jumpTimer = null;

    const machines = [
        { id: "PT100674", ten: "Hệ thống xét nghiệm sinh hóa - miễn dịch tự động và thiết bị hỗ trợ", model: "24d" },
        { id: "PT100673", ten: "Máy đếm tế bào dòng chảy (flow cytometry)", model: "NAVIOS (8 COLOR/2LASER)" },
        { id: "PT100661", ten: "Máy phân tích huyết học tự động ≥ 50 thông số", model: "DxH 800" },
        { id: "PT100663", ten: "Máy phân tích miễn dịch tự động ≥ 150 test/giờ", model: "DxI 800" }
    ];

    function forceSelect(el) {
        el.type = 'text';
        setTimeout(() => {
            el.select();
            el.setSelectionRange(0, 9999);
            setTimeout(() => { el.type = 'number'; }, 10);
        }, 10);
    }

    function jumpAndSelect(prefix, currentIdx, maxIdx) {
        if (jumpTimer) clearTimeout(jumpTimer);
        const currentEl = document.getElementById(prefix + currentIdx);
        if (currentEl && currentEl.value !== "") {
            jumpTimer = setTimeout(() => {
                if (currentIdx < maxIdx && document.activeElement === currentEl) {
                    const nextEl = document.getElementById(prefix + (currentIdx + 1));
                    if (nextEl) {
                        nextEl.focus();
                        forceSelect(nextEl);
                    }
                }
            }, 300); // Giữ tốc độ siêu tốc 0.3s
        }
    }

    function setToday() {
        const today = new Date();
        document.getElementById('datePicker').value = today.toISOString().split('T')[0];
    }

    function sumSpecial() {
        let total = 0;
        for(let i=1; i<=7; i++) {
            total += (parseInt(document.getElementById('mini-'+i).value) || 0);
        }
        const mainInput = document.getElementById('row-input-1');
        if(mainInput) {
            mainInput.value = total;
            calculateTotal();
        }
    }

    function loadData() {
        const date = document.getElementById('datePicker').value;
        if (!date) return;
        const [y, m, d] = date.split('-');
        document.getElementById('dDay').innerText = d;
        document.getElementById('dMonth').innerText = m;
        document.getElementById('dYear').innerText = y;

        database.ref('reports/' + date).once('value', (snapshot) => {
            const data = snapshot.val() || {};
            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            machines.forEach((mach, i) => {
                const idx = i + 1;
                let val = data[mach.id] || "0";
                body.innerHTML += `<tr>
                    <td class="text-center">${idx}</td>
                    <td class="text-center text-muted"><small>${mach.id}</small></td>
                    <td class="px-3 fw-bold">${mach.ten}</td>
                    <td class="text-center fw-bold text-secondary">${mach.model}</td>
                    <td>
                        <input type="number" id="row-input-${idx}" class="input-number" value="${val}"
                               ${!isEditing ? 'readonly' : ''} 
                               onfocus="forceSelect(this)"
                               oninput="calculateTotal()" 
                               onkeyup="jumpAndSelect('row-input-', ${idx}, ${machines.length})">
                    </td>
                </tr>`;
            });
            calculateTotal();
        });
    }

    function calculateTotal() {
        let total = 0;
        for(let i=1; i<=machines.length; i++) {
            const input = document.getElementById('row-input-' + i);
            if (input) total += (parseInt(input.value) || 0);
        }
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    function saveData() {
        const date = document.getElementById('datePicker').value;
        const updateData = {};
        machines.forEach((m, i) => {
            updateData[m.id] = document.getElementById('row-input-' + (i+1)).value || "0";
        });
        database.ref('reports/' + date).set(updateData).then(() => { 
            alert("Đã lưu thành công!"); 
            lock(); 
        });
    }

    function unlock() {
        isEditing = true;
        document.getElementById('authArea').style.display = "none";
        document.getElementById('editArea').style.display = "block";
        document.getElementById('specialInputArea').style.display = "block";
        loadData();
    }

    function lock() {
        isEditing = false;
        document.getElementById('authArea').style.display = "block";
        document.getElementById('editArea').style.display = "none";
        document.getElementById('specialInputArea').style.display = "none";
        document.getElementById('passInput').value = "";
        loadData();
    }

    document.addEventListener('keydown', (e) => {
        if (e.code === "Space" && document.activeElement.id === "passInput") { e.preventDefault(); unlock(); }
    });

    setToday();
    loadData();
</script>
</body>
</html>
