<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Hi·ªáu Su·∫•t Thi·∫øt B·ªã - BV Ung B∆∞·ªõu CS2</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary-gradient: linear-gradient(135deg, #004e92, #000428);
            --accent-color: #00d2ff;
            --border-color: #333;
        }

        body { 
            background: #eef2f3; 
            font-family: "Times New Roman", Times, serif; 
            padding: 30px 10px;
        }

        /* Khung bao ngo√†i r·ª±c r·ª° */
        .report-wrapper {
            max-width: 1000px;
            margin: auto;
            background: #fff;
            padding: 5px; /* Kho·∫£ng c√°ch cho khung m√†u */
            background: var(--primary-gradient);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .report-content {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
        }

        /* Ti√™u ƒë·ªÅ trang tr√≠ */
        .header-box { border-bottom: 3px double var(--border-color); padding-bottom: 20px; margin-bottom: 30px; }
        .hospital-name { font-size: 1.4rem; font-weight: bold; color: #004e92; text-transform: uppercase; }
        .report-title { 
            text-align: center; font-size: 2.2rem; font-weight: bold; color: #b30000;
            margin: 30px 0; text-transform: uppercase; letter-spacing: 2px;
        }

        /* B·∫£ng k·∫ª khung m√†u m√® r√µ n√©t */
        .main-table { width: 100%; border-collapse: collapse; border: 2px solid var(--border-color); }
        .main-table th { 
            background: var(--primary-gradient); color: #fff; 
            border: 1px solid #fff; padding: 15px; text-align: center;
        }
        .main-table td { border: 1px solid var(--border-color); padding: 10px; vertical-align: middle; }

        /* √î nh·∫≠p li·ªáu n·ªïi b·∫≠t */
        .input-num {
            width: 100%; border: 2px solid transparent; background: #f9f9f9;
            text-align: center; font-size: 1.6rem; font-weight: bold;
            font-family: "Times New Roman", serif; outline: none; border-radius: 5px;
            transition: 0.3s;
        }
        .input-num:focus { border-color: var(--accent-color); background: #fff; box-shadow: 0 0 10px var(--accent-color); }
        .input-num[readonly] { background: transparent; border: none; color: #000; }

        /* Khu v·ª±c 7 √¥ t√≠nh d·ªìn */
        .calc-tool {
            background: #f0faff; border: 2px dashed #004e92; padding: 15px;
            margin-bottom: 20px; border-radius: 10px; display: none;
        }
        .mini-input {
            width: 75px; border: 1px solid #004e92; text-align: center;
            font-weight: bold; border-radius: 4px; padding: 5px; margin: 3px;
        }

        /* M·∫≠t kh·∫©u & ƒêi·ªÅu khi·ªÉn */
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .pwd-input-group { 
            background: #fff; border: 2px solid var(--border-color); 
            border-radius: 20px; padding: 5px 15px;
        }
        #passInput { border: none; outline: none; width: 100px; font-style: italic; }

        .total-row { background: #fffde7; font-weight: bold; font-size: 1.6rem; }
        .total-text { color: #b30000; font-size: 2rem; }
    </style>
</head>
<body>

<div class="report-wrapper">
    <div class="report-content">
        <div class="header-box d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/03/Logo_BV_Ung_B%C6%B0%E1%BB%9Bu_TP.HCM.png" width="80" class="me-3">
                <div>
                    <div class="hospital-name">B·ªánh Vi·ªán Ung B∆∞·ªõu - CS2</div>
                    <div class="fw-bold text-success">üßß KHOA X√âT NGHI·ªÜM</div>
                </div>
            </div>
            <div class="text-end fw-bold text-primary">‚óè H·ªá th·ªëng tr·ª±c tuy·∫øn</div>
        </div>

        <h1 class="report-title">B√°o C√°o Hi·ªáu Su·∫•t Thi·∫øt B·ªã</h1>

        <div class="control-row">
            <div class="d-flex align-items-center gap-2">
                <strong>Ng√†y:</strong>
                <input type="text" id="datePicker" class="form-control text-center fw-bold" style="width:140px; border: 2px solid var(--border-color);">
            </div>
            <div>
                <div class="pwd-input-group" id="authArea">
                    <small>M·∫≠t kh·∫©u:</small>
                    <input type="password" id="passInput" placeholder="Nh·∫≠p ƒë·ªÉ s·ª≠a">
                </div>
                <div id="editArea" style="display:none">
                    <button onclick="saveData()" id="btnSave" class="btn btn-danger fw-bold px-4 shadow">L∆ØU D·ªÆ LI·ªÜU</button>
                    <button onclick="lock()" class="btn btn-outline-dark ms-2">ƒê√ìNG</button>
                </div>
            </div>
        </div>

        <div id="calcTool" class="calc-tool">
            <div class="fw-bold mb-2 text-primary">üßÆ B·ªô t√≠nh c·ªông d·ªìn nhanh (K·∫øt qu·∫£ v√†o d√≤ng 1):</div>
            <div class="d-flex flex-wrap align-items-center">
                <input type="number" class="mini-input" placeholder="√î 1" oninput="doSum()">
                <input type="number" class="mini-input" placeholder="√î 2" oninput="doSum()">
                <input type="number" class="mini-input" placeholder="√î 3" oninput="doSum()">
                <input type="number" class="mini-input" placeholder="√î 4" oninput="doSum()">
                <input type="number" class="mini-input" placeholder="√î 5" oninput="doSum()">
                <input type="number" class="mini-input" placeholder="√î 6" oninput="doSum()">
                <input type="number" class="mini-input" placeholder="√î 7" oninput="doSum()">
                <span class="ms-3 fw-bold fs-5 text-danger">= <span id="res7">0</span></span>
            </div>
        </div>

        <table class="main-table">
            <thead>
                <tr>
                    <th width="10%">STT</th>
                    <th>T√™n H·ªá Th·ªëng / Thi·∫øt B·ªã</th>
                    <th width="20%">Model</th>
                    <th width="20%">S·ªë L∆∞·ª£ng</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3" class="text-end">T·ªîNG C·ªòNG H√îM NAY:</td>
                    <td id="totalValue" class="text-center total-text">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-4 text-end italic" style="font-style: italic; font-weight: bold;">
            Ng√†y <span id="dDay">...</span> th√°ng <span id="dMonth">...</span> nƒÉm 2026
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const machines = [
        { id: "PT100674", ten: "H·ªá th·ªëng x√©t nghi·ªám sinh h√≥a - mi·ªÖn d·ªãch", model: "24d" },
        { id: "PT100673", ten: "M√°y ƒë·∫øm t·∫ø b√†o d√≤ng ch·∫£y (Flow)", model: "NAVIOS" },
        { id: "PT100661", ten: "M√°y ph√¢n t√≠ch huy·∫øt h·ªçc t·ª± ƒë·ªông", model: "DxH 800" },
        { id: "PT100663", ten: "M√°y ph√¢n t√≠ch mi·ªÖn d·ªãch t·ª± ƒë·ªông", model: "DxI 800" }
    ];

    let lastDateKey = "";
    let isEditing = false;

    function init() {
        flatpickr("#datePicker", {
            defaultDate: "today", dateFormat: "d/m/Y",
            onChange: (dates) => {
                lastDateKey = dates[0].toISOString().split('T')[0];
                loadData();
            }
        });
        lastDateKey = new Date().toISOString().split('T')[0];
        loadData();
    }

    function loadData() {
        const [y, m, d] = lastDateKey.split('-');
        document.getElementById('dDay').innerText = d;
        document.getElementById('dMonth').innerText = m;

        db.ref('reports/' + lastDateKey).once('value', (s) => {
            const data = s.val() || {};
            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            
            machines.forEach((m, i) => {
                body.innerHTML += `
                    <tr>
                        <td class="text-center fw-bold">${i+1}</td>
                        <td class="fw-bold px-3">${m.ten}</td>
                        <td class="text-center fw-bold text-primary">${m.model}</td>
                        <td>
                            <input type="number" id="val-${m.id}" class="input-num" 
                            value="${data[m.id] || 0}" ${!isEditing ? 'readonly' : ''} 
                            oninput="calculateTotal()" onfocus="this.select()">
                        </td>
                    </tr>`;
            });
            calculateTotal();
        });
    }

    function doSum() {
        let s = 0;
        document.querySelectorAll('.mini-input').forEach(i => s += parseInt(i.value) || 0);
        document.getElementById('res7').innerText = s;
        const line1 = document.getElementById('val-PT100674');
        if(line1) { line1.value = s; calculateTotal(); }
    }

    function calculateTotal() {
        let t = 0;
        machines.forEach(m => {
            const el = document.getElementById('val-' + m.id);
            if(el) t += parseInt(el.value) || 0;
        });
        document.getElementById('totalValue').innerText = t.toLocaleString('vi-VN');
    }

    // M·∫≠t kh·∫©u l√† 123
    document.getElementById('passInput').addEventListener('input', function() {
        if(this.value === "123") {
            isEditing = true;
            document.getElementById('authArea').style.display = "none";
            document.getElementById('editArea').style.display = "block";
            document.getElementById('calcTool').style.display = "block";
            this.value = "";
            loadData();
        }
    });

    function lock() {
        isEditing = false;
        document.getElementById('authArea').style.display = "flex";
        document.getElementById('editArea').style.display = "none";
        document.getElementById('calcTool').style.display = "none";
        loadData();
    }

    function saveData() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.innerText = "ƒêANG L∆ØU...";
        
        const update = {};
        machines.forEach(m => update[m.id] = document.getElementById('val-' + m.id).value || 0);

        db.ref('reports/' + lastDateKey).set(update).then(() => {
            alert("ƒê√£ l∆∞u d·ªØ li·ªáu b√°o c√°o!");
            btn.disabled = false; btn.innerText = "L∆ØU D·ªÆ LI·ªÜU";
            lock();
        });
    }

    init();
</script>
</body>
</html>
