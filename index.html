<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o C√°o Hi·ªáu Su·∫•t - Xu√¢n B√≠nh Ng·ªç 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #b30000; --gold: #ffd700; --dark-red: #7a0000; }
        body { 
            background: var(--dark-red); font-family: "Times New Roman", Times, serif;
            padding: 60px 20px; background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
        }
        .ong-do-container {
            position: relative; max-width: 900px; margin: auto; background: #fff;
            padding: 40px; border: 10px solid var(--gold);
            border-image: linear-gradient(to bottom right, #ffd700, #ff8c00, #ffd700) 1;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .hinh-thoi {
            position: absolute; width: 70px; height: 70px; background: var(--red);
            border: 3px solid var(--gold); transform: rotate(45deg);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .hinh-thoi span { transform: rotate(-45deg); color: var(--gold); font-weight: bold; font-size: 0.9rem; }
        .top-l { top: -35px; left: -35px; } .top-r { top: -35px; right: -35px; }
        
        .title { text-align: center; color: var(--red); font-weight: bold; font-size: 2.2rem; margin: 20px 0; text-shadow: 1px 1px var(--gold); }
        .table { border: 2px solid var(--red); }
        .table thead th { background: var(--red); color: #fff; text-align: center; border: 1px solid var(--gold); padding: 12px; }
        
        .input-number { 
            width: 100%; border: none; text-align: center; font-size: 1.6rem; 
            font-weight: bold; color: var(--red); background: #fffcf0; outline: none;
            transition: all 0.2s;
        }
        .input-number:focus { background: #fff1c1; color: #000; }
        .input-number[readonly] { background: transparent; cursor: default; }

        #passInput { width: 30px; border: none; background: transparent; color: transparent; outline: none; }
        #status-light { position: fixed; top: 10px; right: 10px; padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; font-size: 12px; z-index: 1000; }
        .no-print { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="status-light" style="background: gray;">ƒêang k·∫øt n·ªëi...</div>

<div class="ong-do-container">
    <div class="hinh-thoi top-l"><span>XU√ÇN</span></div>
    <div class="hinh-thoi top-r"><span>2026</span></div>

    <div class="header d-flex border-bottom border-danger pb-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/03/Logo_BV_Ung_B%C6%B0%E1%BB%9Bu_TP.HCM.png" width="70" class="me-3" style="object-fit: contain;">
        <div>
            <h5 class="m-0 text-danger fw-bold">B·ªÜNH VI·ªÜN UNG B∆Ø·ªöU - CS2</h5>
            <p class="m-0 text-secondary fw-bold small">üßß KHOA X√âT NGHI·ªÜM - XU√ÇN B√çNH NG·ªå 2026</p>
        </div>
    </div>

    <h1 class="title">B√ÅO C√ÅO HI·ªÜU SU·∫§T</h1>

    <div class="no-print">
        <div class="d-flex align-items-center gap-2">
            <b class="text-danger small">L·ªäCH:</b>
            <input type="text" id="datePicker" class="form-control form-control-sm text-center fw-bold shadow-sm" style="width:130px;">
        </div>
        <div class="d-flex align-items-center">
            <input type="password" id="passInput" title="B·∫•m ph√≠m C√°ch ƒë·ªÉ nh·∫≠p">
            <div id="editArea" style="display:none">
                <button onclick="saveData()" id="btnSave" class="btn btn-danger btn-sm fw-bold px-3">L∆ØU D·ªÆ LI·ªÜU</button>
                <button onclick="lock()" class="btn btn-outline-secondary btn-sm ms-2">H·ª¶Y</button>
            </div>
        </div>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th width="8%">STT</th>
                <th>T√™n H·ªá Th·ªëng / Thi·∫øt B·ªã</th>
                <th width="20%">S·ªë L∆∞·ª£ng</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td class="text-center">1</td><td>H·ªá th·ªëng x√©t nghi·ªám sinh h√≥a - mi·ªÖn d·ªãch (24d)</td><td><input type="number" id="val-PT100674" class="input-number" value="0" readonly oninput="calculateTotal()" onfocus="this.select()"></td></tr>
            <tr><td class="text-center">2</td><td>M√°y ƒë·∫øm t·∫ø b√†o d√≤ng ch·∫£y (NAVIOS)</td><td><input type="number" id="val-PT100673" class="input-number" value="0" readonly oninput="calculateTotal()" onfocus="this.select()"></td></tr>
            <tr><td class="text-center">3</td><td>M√°y ph√¢n t√≠ch huy·∫øt h·ªçc t·ª± ƒë·ªông (DxH 800)</td><td><input type="number" id="val-PT100661" class="input-number" value="0" readonly oninput="calculateTotal()" onfocus="this.select()"></td></tr>
            <tr><td class="text-center">4</td><td>M√°y ph√¢n t√≠ch mi·ªÖn d·ªãch t·ª± ƒë·ªông (DxI 800)</td><td><input type="number" id="val-PT100663" class="input-number" value="0" readonly oninput="calculateTotal()" onfocus="this.select()"></td></tr>
        </tbody>
        <tfoot>
            <tr class="table-warning">
                <td colspan="2" class="text-end fw-bold text-danger">T·ªîNG C·ªòNG:</td>
                <td id="totalValue" class="text-center fw-bold fs-3 text-danger">0</td>
            </tr>
        </tfoot>
    </table>
    <div class="text-end mt-3 fw-bold text-danger small">Ng√†y <span id="dDay">..</span> th√°ng <span id="dMonth">..</span> nƒÉm 2026</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const machineIDs = ["PT100674", "PT100673", "PT100661", "PT100663"];
    let lastDateKey = "";

    // 1. Theo d√µi k·∫øt n·ªëi
    db.ref(".info/connected").on("value", s => {
        const light = document.getElementById('status-light');
        light.style.background = s.val() ? "#28a745" : "#dc3545";
        light.innerText = s.val() ? "ƒê√£ k·∫øt n·ªëi" : "M·∫•t m·∫°ng";
    });

    // 2. Kh·ªüi t·∫°o
    function init() {
        flatpickr("#datePicker", {
            defaultDate: "today", dateFormat: "d/m/Y",
            onChange: (dates) => {
                lastDateKey = dates[0].toISOString().split('T')[0];
                loadDataFromFirebase();
            }
        });
        lastDateKey = new Date().toISOString().split('T')[0];
        loadDataFromFirebase();
    }

    // 3. T·∫£i d·ªØ li·ªáu (Ch·ªâ t·∫£i gi√° tr·ªã, kh√¥ng v·∫Ω l·∫°i b·∫£ng)
    function loadDataFromFirebase() {
        const [y, m, d] = lastDateKey.split('-');
        document.getElementById('dDay').innerText = d;
        document.getElementById('dMonth').innerText = m;

        db.ref('reports/' + lastDateKey).once('value', (s) => {
            const data = s.val() || {};
            machineIDs.forEach(id => {
                document.getElementById('val-' + id).value = data[id] || 0;
            });
            calculateTotal();
        });
    }

    function calculateTotal() {
        let total = 0;
        machineIDs.forEach(id => {
            total += parseInt(document.getElementById('val-' + id).value) || 0;
        });
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    // 4. M·ªü kh√≥a (FIX: Kh√¥ng load l·∫°i data, ch·ªâ g·ª° readonly)
    function unlock() {
        document.getElementById('editArea').style.display = "block";
        machineIDs.forEach(id => {
            document.getElementById('val-' + id).removeAttribute('readonly');
        });
        // T·ª± ƒë·ªông focus v√†o √¥ ƒë·∫ßu ti√™n sau khi m·ªü kh√≥a
        document.getElementById('val-' + machineIDs[0]).focus();
    }

    function lock() {
        document.getElementById('editArea').style.display = "none";
        machineIDs.forEach(id => {
            document.getElementById('val-' + id).setAttribute('readonly', true);
        });
        loadDataFromFirebase(); // Ch·ªâ load l·∫°i khi b·∫•m H·ªßy ƒë·ªÉ tr·∫£ v·ªÅ gi√° tr·ªã c≈©
    }

    function saveData() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true;
        const update = {};
        machineIDs.forEach(id => {
            update[id] = document.getElementById('val-' + id).value || 0;
        });

        db.ref('reports/' + lastDateKey).set(update).then(() => {
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
            btn.disabled = false;
            lock();
        });
    }

    // Ph√≠m t·∫Øt: C√°ch (Space) t·∫°i √¥ m·∫≠t kh·∫©u ƒë·ªÉ nh·∫≠p
    document.getElementById('passInput').addEventListener('keydown', (e) => {
        if (e.code === "Space") { e.preventDefault(); unlock(); }
    });

    init();
</script>
</body>
</html>
