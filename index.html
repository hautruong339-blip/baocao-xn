<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Hiệu Suất - BV Ung Bướu CS2</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --bv-blue: #00529b; --bv-green: #2ecc71; }
        body { background-color: #f0f4f8; font-family: "Times New Roman", Times, serif; padding: 20px; color: #333; }
        .report-card { max-width: 1100px; margin: auto; background: white; border-radius: 4px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); padding: 50px; border-top: 10px solid var(--bv-blue); }
        .hospital-brand { border-bottom: 2px solid var(--bv-green); margin-bottom: 20px; padding-bottom: 10px; }
        .hospital-name { color: var(--bv-blue); font-weight: bold; font-size: 1.4rem; margin: 0; text-transform: uppercase; }
        .report-title { text-align: center; font-weight: bold; margin: 30px 0; font-size: 1.8rem; text-transform: uppercase; color: #000; }
        .table { border: 1.5px solid #000; width: 100%; }
        .table thead th { background-color: #f8f9fa; color: #000; text-align: center; border: 1px solid #000; font-weight: bold; padding: 12px; }
        .table td { border: 1px solid #000; vertical-align: middle; padding: 10px; }
        .col-quantity { text-align: right; padding-right: 15px !important; }
        .input-number { width: 100%; border: none; text-align: right; font-weight: bold; background: transparent; font-size: 1.2rem; color: var(--bv-blue); }
        .input-number:focus { outline: none; background: #fff9c4; }
        .special-group { display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
        .sub-input { width: 40px; border: 1px solid #ccc; text-align: center; font-size: 0.85rem; border-radius: 3px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .control-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .footer-date { margin-top: 40px; text-align: right; font-style: italic; font-size: 1.2rem; padding-right: 30px; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="report-card">
    <div class="hospital-brand">
        <p class="hospital-name">SỞ Y TẾ TP. HỒ CHÍ MINH</p>
        <p class="hospital-name">BỆNH VIỆN UNG BƯỚU - CS2</p>
        <p class="mb-0 fw-bold" style="color: var(--bv-green)">KHOA XÉT NGHIỆM</p>
    </div>
    <h3 class="report-title">BẢNG BÁO CÁO HIỆU SUẤT XÉT NGHIỆM HẰNG NGÀY</h3>

    <div class="control-bar no-print">
        <input type="date" id="datePicker" class="form-control" onchange="loadData()" style="width: 170px; border: 2px solid var(--bv-blue); border-radius: 20px;">
        <div id="authArea">
            <input type="password" id="passInput" placeholder="Mật khẩu" class="form-control d-inline-block" style="width: 100px; border-radius: 20px;">
            <button onclick="unlock()" class="btn btn-primary px-3" style="border-radius: 20px;">Mở khóa</button>
        </div>
        <div id="editArea" style="display: none;">
            <button onclick="saveData()" class="btn btn-success fw-bold px-4" style="border-radius: 20px;">LƯU DỮ LIỆU</button>
            <button onclick="lock()" class="btn btn-outline-secondary ms-2" style="border-radius: 20px;">Đóng</button>
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th width="5%">STT</th>
                <th width="15%">MÃ MÁY</th>
                <th width="40%">TÊN THIẾT BỊ</th>
                <th width="20%">MODEL</th>
                <th width="20%">SỐ LƯỢNG</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr style="background: #f8f9fa; font-weight: bold;">
                <td colspan="4" class="text-end px-4">TỔNG CỘNG</td>
                <td id="totalValue" class="col-quantity text-danger fs-5">0</td>
            </tr>
        </tfoot>
    </table>
    <div class="footer-date">Ngày <span id="dDay">..</span> tháng <span id="dMonth">..</span> năm <span id="dYear">20..</span></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const PASSWORD = "1";
    let isEditing = false;
    let currentData = {}; // Biến lưu trữ dữ liệu hiện tại để không bị mất

    const machines = [
        { id: "PT100674", ten: "Hệ thống xét nghiệm sinh hóa - miễn dịch", model: "24d", isSpecial: true },
        { id: "PT100673", ten: "Máy đếm tế bào dòng chảy", model: "NAVIOS" },
        { id: "PT100661", ten: "Máy phân tích huyết học tự động", model: "DxH 800" },
        { id: "PT100663", ten: "Máy phân tích miễn dịch tự động", model: "DxI 800" }
    ];

    document.getElementById('datePicker').valueAsDate = new Date();

    // CHẶN TUYỆT ĐỐI CHỮ VÀ KÝ TỰ (Chỉ cho phép số 0-9)
    function onlyNumber(e) {
        if (e.which < 48 || e.which > 57) e.preventDefault();
    }

    function unlock() {
        if(document.getElementById('passInput').value === PASSWORD) {
            isEditing = true;
            document.getElementById('authArea').style.display = "none";
            document.getElementById('editArea').style.display = "block";
            loadData();
        } else { alert("Mật khẩu sai!"); }
    }

    function lock() {
        isEditing = false;
        document.getElementById('authArea').style.display = "block";
        document.getElementById('editArea').style.display = "none";
        loadData();
    }

    function loadData() {
        const date = document.getElementById('datePicker').value;
        const d = new Date(date);
        document.getElementById('dDay').innerText = d.getDate().toString().padStart(2, '0');
        document.getElementById('dMonth').innerText = (d.getMonth() + 1).toString().padStart(2, '0');
        document.getElementById('dYear').innerText = d.getFullYear();

        database.ref('reports/' + date).once('value', (snapshot) => {
            const fbData = snapshot.val() || {};
            // Lấy dữ liệu tạm từ localStorage nếu có
            const localData = JSON.parse(localStorage.getItem('draft_' + date)) || {};
            
            // Hợp nhất dữ liệu: Ưu tiên localData nếu đang sửa, không thì lấy fbData
            currentData = isEditing ? { ...fbData, ...localData } : fbData;

            const body = document.getElementById('tableBody');
            body.innerHTML = "";

            machines.forEach((m, i) => {
                let val = currentData[m.id] || "0";
                let html = "";

                if (m.isSpecial && isEditing) {
                    html = `<div class="special-group">`;
                    for(let j=0; j<7; j++) {
                        html += `<input type="number" class="sub-input no-print" onkeypress="onlyNumber(event)" oninput="sumUp('${m.id}')">`;
                    }
                    html += `<span id="label-${m.id}" class="input-number" style="width:auto; min-width:50px">${val}</span>`;
                    html += `<input type="hidden" id="input-${m.id}" value="${val}"></div>`;
                } else {
                    html = `<input type="number" class="input-number" ${!isEditing ? 'readonly' : ''} 
                             onkeypress="onlyNumber(event)" oninput="updateVal('${m.id}', this.value)"
                             onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'; updateVal('${m.id}', this.value)"
                             id="input-${m.id}" value="${val}">`;
                }

                body.innerHTML += `<tr>
                    <td class="text-center">${i+1}</td>
                    <td class="text-center"><small>${m.id}</small></td>
                    <td>${m.ten}</td>
                    <td class="text-center fw-bold">${m.model}</td>
                    <td class="col-quantity">${html}</td>
                </tr>`;
            });
            calculateTotal();
        });
    }

    // Cập nhật giá trị vào biến tạm và lưu LocalStorage ngay lập tức
    function updateVal(id, value) {
        currentData[id] = value || "0";
        const date = document.getElementById('datePicker').value;
        localStorage.setItem('draft_' + date, JSON.stringify(currentData));
        calculateTotal();
    }

    function sumUp(mId) {
        const group = document.querySelector('.special-group');
        const subs = group.querySelectorAll('.sub-input');
        let total = 0;
        subs.forEach(s => total += (parseInt(s.value) || 0));
        document.getElementById(`label-${mId}`).innerText = total;
        updateVal(mId, total.toString());
    }

    function calculateTotal() {
        let grandTotal = 0;
        machines.forEach(m => {
            grandTotal += (parseInt(currentData[m.id]) || 0);
        });
        document.getElementById('totalValue').innerText = grandTotal.toLocaleString('vi-VN');
    }

    function saveData() {
        const date = document.getElementById('datePicker').value;
        database.ref('reports/' + date).set(currentData).then(() => { 
            alert("Đã lưu thành công lên hệ thống!"); 
            localStorage.removeItem('draft_' + date); // Xóa bản nháp sau khi lưu thành công
            lock(); 
        }).catch(err => alert("Lỗi kết nối: " + err.message));
    }

    loadData();
</script>
</body>
</html>
