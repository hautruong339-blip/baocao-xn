<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Hi·ªáu Su·∫•t - Xu√¢n B√≠nh Ng·ªç 2026</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #b30000; --gold: #ffd700; --dark-red: #7a0000; }
        
        body { 
            background: var(--dark-red); 
            font-family: "Times New Roman", Times, serif;
            padding: 80px 20px;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            overflow-x: hidden;
        }

        #blossom-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.7; }

        /* --- KHUNG TRANG TR√ç --- */
        .ong-do-container {
            position: relative; max-width: 1050px; margin: auto; background: #fff;
            padding: 50px; border: 12px solid var(--gold);
            border-image: linear-gradient(to bottom right, #ffd700, #ff8c00, #ffd700) 1;
            box-shadow: 0 0 80px rgba(0,0,0,0.6);
            border-radius: 4px;
        }

        /* Tr·∫°ng th√°i k·∫øt n·ªëi */
        #conn-status {
            position: fixed; top: 15px; left: 15px; padding: 6px 15px;
            border-radius: 20px; font-weight: bold; font-size: 0.85rem; z-index: 10000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .online { background: #28a745; color: white; border: 1px solid #fff; }
        .offline { background: #dc3545; color: white; border: 1px solid #fff; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        /* H√¨nh thoi 4 g√≥c */
        .hinh-thoi {
            position: absolute; width: 90px; height: 90px; background: var(--red);
            border: 4px solid var(--gold); transform: rotate(45deg);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .hinh-thoi span { transform: rotate(-45deg); color: var(--gold); font-weight: bold; font-size: 1.2rem; }
        .top-l { top: -50px; left: -50px; } .top-r { top: -50px; right: -50px; }
        .bot-l { bottom: -50px; left: -50px; } .bot-r { bottom: -50px; right: -50px; }

        .header { border-bottom: 3px solid var(--red); padding-bottom: 20px; margin-bottom: 30px; }
        .title { text-align: center; color: var(--red); font-weight: bold; font-size: 2.8rem; text-shadow: 2px 2px var(--gold); margin-bottom: 30px; }

        /* --- B·∫¢NG D·ªÆ LI·ªÜU --- */
        .table { border: 2.5px solid var(--red); margin-bottom: 0; }
        .table thead th { 
            background: var(--red); color: #fff; text-align: center; 
            padding: 15px; border: 1.5px solid var(--gold); text-transform: uppercase;
        }
        .table td { vertical-align: middle; border: 1px solid var(--red); font-weight: bold; font-size: 1.2rem; padding: 12px; }
        
        /* Input Ch·ªëng Lag */
        .input-number { 
            width: 100%; border: none; text-align: center; 
            font-size: 1.8rem; font-weight: bold; background: #fffcf0; 
            color: var(--red); border-radius: 5px; outline: none;
        }
        .input-number:focus { background: #fff1c1; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .input-number[readonly] { background: transparent; cursor: default; }

        #passInput { width: 40px; border: none; background: transparent; color: transparent; cursor: default; }
        .footer-date { color: var(--red); text-align: right; margin-top: 30px; font-size: 1.4rem; font-weight: bold; }
    </style>
</head>
<body>

<div id="conn-status" class="offline">ƒêang k·∫øt n·ªëi...</div>
<canvas id="blossom-canvas"></canvas>

<div class="ong-do-container">
    <div class="hinh-thoi top-l"><span>CH√öC</span></div>
    <div class="hinh-thoi top-r"><span>M·ª™NG</span></div>
    <div class="hinh-thoi bot-l"><span>NƒÇM</span></div>
    <div class="hinh-thoi bot-r"><span>M·ªöI</span></div>

    <div class="header d-flex align-items-center">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/03/Logo_BV_Ung_B%C6%B0%E1%BB%9Bu_TP.HCM.png" width="100" class="me-4" onerror="this.style.display='none'">
        <div>
            <h3 class="fw-bold text-danger m-0">S·ªû Y T·∫æ TP. H·ªí CH√ç MINH</h3>
            <h3 class="fw-bold text-danger m-0">B·ªÜNH VI·ªÜN UNG B∆Ø·ªöU - CS2</h3>
            <h5 class="text-secondary fw-bold mt-1">üßß KHOA X√âT NGHI·ªÜM - XU√ÇN B√çNH NG·ªå 2026</h5>
        </div>
    </div>

    <h1 class="title">B√ÅO C√ÅO HI·ªÜU SU·∫§T</h1>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <b class="text-danger">L·ªãch B√°o C√°o:</b>
            <input type="text" id="datePicker" class="form-control text-center fw-bold border-danger shadow-sm" style="width:160px; border-radius: 20px;">
        </div>
        <div>
            <div id="authArea"><input type="password" id="passInput" autocomplete="off"></div>
            <div id="editArea" style="display:none">
                <button id="btnSave" onclick="saveData()" class="btn btn-danger fw-bold rounded-pill px-4 shadow-sm">L∆ØU D·ªÆ LI·ªÜU</button>
                <button onclick="lock()" class="btn btn-outline-secondary rounded-pill ms-2">ƒê√ìNG</button>
            </div>
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th width="8%">STT</th>
                <th>T√™n H·ªá Th·ªëng / Thi·∫øt B·ªã</th>
                <th width="20%">Model</th>
                <th width="18%">S·ªë L∆∞·ª£ng</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr style="background:#fff5f5">
                <td colspan="3" class="text-end fw-bold text-danger fs-5">T·ªîNG C·ªòNG HI·ªÜU SU·∫§T:</td>
                <td id="totalValue" class="text-center fw-bold text-danger fs-2">0</td>
            </tr>
        </tfoot>
    </table>

    <div class="footer-date">Ng√†y <span id="dDay">..</span> th√°ng <span id="dMonth">..</span> nƒÉm 2026</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>

<script>
    // 1. C·∫§U H√åNH FIREBASE
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. BI·∫æN TO√ÄN C·ª§C
    let isEditing = false;
    let lastDateKey = "";
    const machines = [
        { id: "PT100674", ten: "H·ªá th·ªëng x√©t nghi·ªám sinh h√≥a - mi·ªÖn d·ªãch t·ª± ƒë·ªông", model: "24d" },
        { id: "PT100673", ten: "M√°y ƒë·∫øm t·∫ø b√†o d√≤ng ch·∫£y (flow cytometry)", model: "NAVIOS" },
        { id: "PT100661", ten: "M√°y ph√¢n t√≠ch huy·∫øt h·ªçc t·ª± ƒë·ªông ‚â• 50 th√¥ng s·ªë", model: "DxH 800" },
        { id: "PT100663", ten: "M√°y ph√¢n t√≠ch mi·ªÖn d·ªãch t·ª± ƒë·ªông ‚â• 150 test/gi·ªù", model: "DxI 800" }
    ];

    // 3. THEO D√ïI K·∫æT N·ªêI
    database.ref(".info/connected").on("value", (snap) => {
        const status = document.getElementById('conn-status');
        if (snap.val() === true) {
            status.innerText = "‚óè ƒê√£ k·∫øt n·ªëi"; status.className = "online";
        } else {
            status.innerText = "‚óã M·∫•t k·∫øt n·ªëi"; status.className = "offline";
        }
    });

    // 4. KH·ªûI T·∫†O APP
    function initApp() {
        const fp = flatpickr("#datePicker", {
            locale: "vn", dateFormat: "d/m/Y", defaultDate: "today",
            onChange: (selectedDates) => {
                lastDateKey = flatpickr.formatDate(selectedDates[0], "Y-m-d");
                loadData(lastDateKey);
            }
        });
        lastDateKey = flatpickr.formatDate(new Date(), "Y-m-d");
        loadData(lastDateKey);
        startBlossom();
    }

    // 5. T·∫¢I D·ªÆ LI·ªÜU (D√πng .once ƒë·ªÉ ch·ªëng gi·∫≠t trang)
    function loadData(dateKey) {
        const [y, m, d] = dateKey.split('-');
        document.getElementById('dDay').innerText = d;
        document.getElementById('dMonth').innerText = m;
        
        database.ref('reports/' + dateKey).once('value', (s) => {
            renderTable(s.val() || {});
        });
    }

    // 6. HI·ªÇN TH·ªä B·∫¢NG (Ch·ªëng nh·∫£y √¥)
    function renderTable(data) {
        const body = document.getElementById('tableBody');
        let html = "";
        machines.forEach((m, i) => {
            let val = data[m.id] || "0";
            html += `<tr>
                <td class="text-center">${i+1}</td>
                <td class="px-3">${m.ten}</td>
                <td class="text-center text-secondary">${m.model}</td>
                <td>
                    <input type="number" id="input-${i}" class="input-number" 
                    value="${val}" ${!isEditing ? 'readonly' : ''} 
                    oninput="calculateTotal()" onfocus="this.select()">
                </td>
            </tr>`;
        });
        body.innerHTML = html;
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        machines.forEach((_, i) => {
            const input = document.getElementById('input-' + i);
            if (input) total += (parseInt(input.value) || 0);
        });
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    // 7. L∆ØU D·ªÆ LI·ªÜU
    function saveData() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.innerText = "ƒêANG L∆ØU...";

        const update = {};
        machines.forEach((m, i) => {
            update[m.id] = document.getElementById('input-' + i).value || "0";
        });

        database.ref('reports/' + lastDateKey).set(update).then(() => {
            alert("ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!");
            btn.disabled = false; btn.innerText = "L∆ØU D·ªÆ LI·ªÜU";
            lock();
        }).catch(e => {
            alert("L·ªói l∆∞u d·ªØ li·ªáu: " + e.message);
            btn.disabled = false;
        });
    }

    // 8. B·∫¢O M·∫¨T & M·ªû KH√ìA (B·∫•m Space t·∫°i √¥ ·∫©n)
    function unlock() { 
        isEditing = true; 
        document.getElementById('authArea').style.display = "none"; 
        document.getElementById('editArea').style.display = "block";
        loadData(lastDateKey); 
    }
    
    function lock() { 
        isEditing = false; 
        document.getElementById('authArea').style.display = "block"; 
        document.getElementById('editArea').style.display = "none";
        document.getElementById('passInput').value = "";
        loadData(lastDateKey); 
    }

    document.getElementById('passInput').addEventListener('keydown', (e) => {
        if (e.code === "Space") { e.preventDefault(); unlock(); }
    });

    // 9. HI·ªÜU ·ª®NG HOA MAI (T·ªëi ∆∞u nh·∫π cho m√°y y·∫øu)
    function startBlossom() {
        const canvas = document.getElementById('blossom-canvas');
        const ctx = canvas.getContext('2d');
        let petals = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        class Petal {
            constructor() { this.reset(); this.y = Math.random() * canvas.height; }
            reset() {
                this.x = Math.random() * canvas.width; this.y = -20;
                this.s = Math.random() * 5 + 3; this.v = Math.random() * 1.2 + 0.5;
                this.a = Math.random() * 360;
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.a * Math.PI/180);
                ctx.fillStyle = "#FFD700"; ctx.beginPath();
                for(let i=0; i<5; i++) { ctx.rotate(72*Math.PI/180); ctx.ellipse(0, -this.s, this.s/1.5, this.s, 0, 0, 2*Math.PI); }
                ctx.fill(); ctx.restore();
            }
            update() { this.y += this.v; this.x += Math.sin(this.y/50); if(this.y > canvas.height) this.reset(); }
        }
        for(let i=0; i<25; i++) petals.push(new Petal());
        function anim() { ctx.clearRect(0,0,canvas.width, canvas.height); petals.forEach(p=>{p.update(); p.draw();}); requestAnimationFrame(anim); }
        anim();
    }

    initApp();
</script>
</body>
</html>
