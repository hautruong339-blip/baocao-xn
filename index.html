<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o C√°o Hi·ªáu Su·∫•t - Xu√¢n B√≠nh Ng·ªç 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #b30000; --gold: #ffd700; --dark-red: #7a0000; }
        
        body { 
            background: var(--dark-red); 
            font-family: "Times New Roman", Times, serif;
            padding: 100px 20px;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            overflow-x: hidden;
        }

        #blossom-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* --- KHUNG TRANG TR√ç √îNG ƒê·ªí --- */
        .ong-do-container {
            position: relative;
            max-width: 1100px;
            margin: auto;
            background: #fff;
            padding: 60px;
            border: 12px solid var(--gold);
            border-image: linear-gradient(to bottom right, #ffd700, #ff8c00, #ffd700) 1;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            border-radius: 4px;
        }

        /* H√¨nh thoi 4 g√≥c - CƒÉn gi·ªØa ch·ªØ tuy·ªát ƒë·ªëi */
        .hinh-thoi {
            position: absolute; width: 100px; height: 100px; background: var(--red);
            border: 4px solid var(--gold); transform: rotate(45deg);
            display: flex; align-items: center; justify-content: center; z-index: 100;
            box-shadow: 2px 2px 15px rgba(0,0,0,0.5);
        }
        .hinh-thoi span { 
            transform: rotate(-45deg); color: var(--gold); 
            font-weight: bold; font-size: 1.4rem; text-align: center;
            display: block; width: 100%;
        }
        .top-l { top: -60px; left: -60px; }
        .top-r { top: -60px; right: -60px; }
        .bot-l { bottom: -60px; left: -60px; }
        .bot-r { bottom: -60px; right: -60px; }

        /* C√¢u ƒë·ªëi ƒë·ªè - CƒÉn gi·ªØa ch·ªØ */
        .cau-doi {
            position: absolute; top: 120px; width: 80px; background: var(--red);
            border: 3px solid var(--gold); color: var(--gold); 
            padding: 30px 0; font-size: 2rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl; text-orientation: upright;
            box-shadow: 5px 5px 25px rgba(0,0,0,0.4);
        }
        .cau-doi-l { left: -110px; }
        .cau-doi-r { right: -110px; }

        .header { display: flex; align-items: center; border-bottom: 3px solid var(--red); padding-bottom: 25px; margin-bottom: 40px; }
        .logo { width: 120px; margin-right: 30px; }
        .hospital-info h3 { color: var(--dark-red); margin: 0; font-size: 1.6rem; font-weight: bold; text-transform: uppercase; }
        .hospital-info h4 { color: var(--red); margin: 5px 0 0; font-size: 1.3rem; font-weight: bold; }

        .title { 
            text-align: center; color: var(--red); font-weight: bold; 
            font-size: 3rem; text-shadow: 2px 2px var(--gold); 
            text-transform: uppercase; margin: 30px 0 50px; 
        }

        /* --- B·∫¢NG ƒê·ªíNG B·ªò FONT TIMES --- */
        .table { border: 2.5px solid var(--red); }
        .table thead th { 
            background: var(--red); color: #fff; text-align: center; 
            vertical-align: middle !important; padding: 20px 10px; border: 1.5px solid var(--gold);
            font-size: 1.2rem; text-transform: uppercase;
        }
        .table td { 
            vertical-align: middle; text-align: center; padding: 15px; 
            border: 1px solid var(--red); font-weight: bold; font-size: 1.2rem;
        }
        .table td:nth-child(3) { text-align: left; padding-left: 20px; } 
        
        .input-number { 
            width: 100%; border: none; text-align: center; 
            font-size: 1.8rem; font-weight: bold; background: #fffcf0; 
            color: var(--red); border-radius: 5px;
        }

        /* L·ªãch √¥ vu√¥ng ƒë·ªè */
        .flatpickr-day.today {
            background: var(--red) !important; color: #fff !important;
            border-radius: 4px !important; border: 2px solid var(--gold) !important;
        }

        #passInput { width: 50px; border: none; background: transparent; }
        .footer-date { color: var(--red); text-align: right; margin-top: 40px; font-size: 1.4rem; font-weight: bold; }
    </style>
</head>
<body>

<canvas id="blossom-canvas"></canvas>

<div class="ong-do-container" id="mainReport">
    <div class="hinh-thoi top-l"><span>CH√öC</span></div>
    <div class="hinh-thoi top-r"><span>M·ª™NG</span></div>
    <div class="hinh-thoi bot-l"><span>NƒÇM</span></div>
    <div class="hinh-thoi bot-r"><span>M·ªöI</span></div>

    <div class="cau-doi cau-doi-l">V·∫°n S·ª± Nh∆∞ √ù</div>
    <div class="cau-doi cau-doi-r">An Khang Th·ªãnh V∆∞·ª£ng</div>

    <div class="header">
        <img src="logo.png" onerror="this.src='OIP.webp'" class="logo">
        <div class="hospital-info">
            <h3>S·ªû Y T·∫æ TP. H·ªí CH√ç MINH</h3>
            <h3>B·ªÜNH VI·ªÜN UNG B∆Ø·ªöU - CS2</h3>
            <h4>üßß KHOA X√âT NGHI·ªÜM - XU√ÇN B√çNH NG·ªå 2026</h4>
        </div>
    </div>

    <h1 class="title">B√ÅO C√ÅO HI·ªÜU SU·∫§T X√âT NGHI·ªÜM</h1>

    <div class="d-flex justify-content-between align-items-center mb-5 no-print">
        <div class="d-flex align-items-center gap-2">
            <b class="text-danger fs-5">L·ªãch B√°o C√°o:</b>
            <input type="text" id="datePicker" class="form-control text-center fw-bold border-danger shadow-sm" style="width:180px; border-radius: 20px;">
        </div>
        <div id="authArea"><input type="password" id="passInput"></div>
        <div id="editArea" style="display:none">
            <button onclick="saveData()" class="btn btn-danger fw-bold rounded-pill px-4 shadow-sm">L∆∞u D·ªØ Li·ªáu</button>
            <button onclick="lock()" class="btn btn-outline-secondary rounded-pill ms-2">ƒê√≥ng</button>
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th width="7%">STT</th>
                <th width="12%">M√£ M√°y</th>
                <th>T√™n H·ªá Th·ªëng / Thi·∫øt B·ªã</th>
                <th width="18%">Model</th>
                <th width="15%">S·ªë L∆∞·ª£ng</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr style="background:#fff5f5">
                <td colspan="4" class="text-end fw-bold" style="color:var(--red); font-size: 1.4rem; padding-right: 30px;">T·ªîNG C·ªòNG HI·ªÜU SU·∫§T XU√ÇN</td>
                <td id="totalValue" class="text-center fw-bold text-danger" style="font-size: 2rem;">0</td>
            </tr>
        </tfoot>
    </table>
    <div class="footer-date">Ng√†y <span id="dDay">..</span> th√°ng <span id="dMonth">..</span> nƒÉm 2026</div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let isEditing = false;
    let calendarInstance;
    let lastDateKey = "";
    const machines = [
        { id: "PT100674", ten: "H·ªá th·ªëng x√©t nghi·ªám sinh h√≥a - mi·ªÖn d·ªãch t·ª± ƒë·ªông v√† thi·∫øt b·ªã h·ªó tr·ª£", model: "24d" },
        { id: "PT100673", ten: "M√°y ƒë·∫øm t·∫ø b√†o d√≤ng ch·∫£y (flow cytometry)", model: "NAVIOS (8 COLOR/2LASER)" },
        { id: "PT100661", ten: "M√°y ph√¢n t√≠ch huy·∫øt h·ªçc t·ª± ƒë·ªông ‚â• 50 th√¥ng s·ªë", model: "DxH 800" },
        { id: "PT100663", ten: "M√°y ph√¢n t√≠ch mi·ªÖn d·ªãch t·ª± ƒë·ªông ‚â• 150 test/gi·ªù", model: "DxI 800" }
    ];

    // --- HI·ªÜU ·ª®NG HOA MAI R∆†I ---
    const canvas = document.getElementById('blossom-canvas');
    const ctx = canvas.getContext('2d');
    let petals = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    class Petal {
        constructor() { this.reset(); this.y = Math.random() * canvas.height; }
        reset() {
            this.x = Math.random() * canvas.width; this.y = -20;
            this.size = Math.random() * 8 + 6; this.speed = Math.random() * 1.5 + 0.8;
            this.angle = Math.random() * 360; this.spin = Math.random() * 2 - 1;
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle * Math.PI / 180);
            ctx.beginPath(); ctx.fillStyle = "#FFD700"; 
            for(let i=0; i<5; i++) { ctx.rotate(72 * Math.PI / 180); ctx.ellipse(0, -this.size/2, this.size/2, this.size, 0, 0, 2 * Math.PI); }
            ctx.fill(); ctx.beginPath(); ctx.fillStyle = "#FF4500"; ctx.arc(0, 0, this.size/4, 0, 2 * Math.PI); ctx.fill(); ctx.restore();
        }
        update() { this.y += this.speed; this.x += Math.sin(this.y / 50); this.angle += this.spin; if (this.y > canvas.height) this.reset(); }
    }
    for(let i=0; i<45; i++) petals.push(new Petal());
    function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); petals.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
    animate();

    // --- LOGIC D·ªÆ LI·ªÜU ---
    function initApp() {
        const today = new Date();
        calendarInstance = flatpickr("#datePicker", {
            locale: "vn", dateFormat: "d/m/Y", defaultDate: today,
            onChange: (selectedDates) => {
                const dateKey = calendarInstance.formatDate(selectedDates[0], "Y-m-d");
                lastDateKey = dateKey; loadData(dateKey);
            }
        });
        lastDateKey = calendarInstance.formatDate(today, "Y-m-d");
        loadData(lastDateKey);
    }

    function loadData(dateKey) {
        const [y, m, d] = dateKey.split('-');
        document.getElementById('dDay').innerText = d; document.getElementById('dMonth').innerText = m;
        database.ref('reports/' + dateKey).once('value', (s) => renderTable(s.val() || {}, s.exists()));
    }

    function renderTable(data, hasContent) {
        const body = document.getElementById('tableBody'); body.innerHTML = "";
        machines.forEach((mach, i) => {
            const idx = i + 1; let val = data[mach.id] || "0";
            body.innerHTML += `<tr><td class="text-center">${idx}</td><td class="text-center text-muted"><small>${mach.id}</small></td><td class="px-3">${mach.ten}</td><td class="text-center text-secondary">${mach.model}</td><td><input type="number" id="row-input-${idx}" class="input-number" value="${val}" ${!isEditing ? 'readonly' : ''} onfocus="handleFocus(this)" oninput="calculateTotal()"></td></tr>`;
        });
        calculateTotal();
    }

    function handleFocus(el) { if (el.value === "0") el.value = ""; setTimeout(() => el.select(), 10); }
    function calculateTotal() {
        let total = 0; for(let i=1; i<=machines.length; i++) { const input = document.getElementById('row-input-' + i); if (input) total += (parseInt(input.value) || 0); }
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    function saveData() {
        const update = {}; machines.forEach((m, i) => { update[m.id] = document.getElementById('row-input-' + (i+1)).value || "0"; });
        database.ref('reports/' + lastDateKey).set(update).then(() => { alert("ƒê√£ l∆∞u th√†nh c√¥ng!"); lock(); });
    }

    function unlock() { isEditing = true; document.getElementById('authArea').style.display = "none"; document.getElementById('editArea').style.display = "block"; loadData(lastDateKey); }
    function lock() { isEditing = false; document.getElementById('authArea').style.display = "block"; document.getElementById('editArea').style.display = "none"; document.getElementById('passInput').value = ""; loadData(lastDateKey); }

    document.addEventListener('keydown', (e) => {
        const pass = document.getElementById('passInput');
        if (document.activeElement === pass && e.code === "Space") { e.preventDefault(); if (pass.value === "") unlock(); else pass.value = ""; }
    });

    initApp();
</script>
</body>
</html>
