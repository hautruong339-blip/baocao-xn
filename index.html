<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Hi·ªáu Su·∫•t - BV Ung B∆∞·ªõu (Firebase Cloud)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --bv-blue: #00529b; --bv-light: #f8fbff; }
        body { background-color: #e9ecef; font-family: 'Segoe UI', Tahoma, sans-serif; padding: 20px; }
        .report-card { max-width: 1050px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 40px; position: relative; }
        
        .hospital-brand { border-bottom: 2px solid var(--bv-blue); margin-bottom: 30px; padding-bottom: 10px; }
        .hospital-name { color: var(--bv-blue); font-weight: bold; font-size: 1.4rem; margin: 0; }
        .report-title { text-align: center; text-transform: uppercase; font-weight: 800; color: #333; margin: 20px 0; letter-spacing: 1px; }

        .table thead th { background-color: #f1f3f5; color: #333; text-align: center; border: 1px solid #dee2e6; font-size: 0.85rem; }
        .table td { border: 1px solid #dee2e6; vertical-align: middle; }
        
        .input-number { 
            width: 100%; border: none; text-align: right; font-weight: bold; 
            background: transparent; font-size: 1.1rem;
        }
        .input-number:focus { outline: none; background: #fffde7; }
        .input-number[readonly] { color: #555; cursor: default; }

        .lock-panel { background: #fff9c4; padding: 10px 20px; border-radius: 5px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #ffe57f; }
        
        .signature-section { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
        .sig-box { text-align: center; min-width: 200px; }
        
        @media print {
            .lock-panel, .btn-save, .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .report-card { box-shadow: none; border: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="report-card">
    <div class="hospital-brand">
        <p class="hospital-name">S·ªû Y T·∫æ TP. H·ªí CH√ç MINH</p>
        <p class="hospital-name">B·ªÜNH VI·ªÜN UNG B∆Ø·ªöU</p>
        <p class="small mb-0">KHOA: X√âT NGHI·ªÜM</p>
    </div>

    <h3 class="report-title">B·∫¢NG B√ÅO C√ÅO HI·ªÜU SU·∫§T X√âT NGHI·ªÜM H·∫∞NG NG√ÄY</h3>

    <div class="lock-panel no-print">
        <div>
            <label class="fw-bold me-2">Ng√†y xem:</label>
            <input type="date" id="datePicker" onchange="loadData()" class="border-0 bg-transparent fw-bold">
        </div>
        <div id="authArea">
            <span id="lockStatus" class="me-2 text-danger">üîí ƒêang kh√≥a (Ch·ªâ xem)</span>
            <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u" class="form-control form-control-sm d-inline-block" style="width: 100px;">
            <button onclick="unlock()" class="btn btn-dark btn-sm">M·ªü kh√≥a</button>
        </div>
        <div id="editArea" style="display: none;">
            <span class="text-success fw-bold me-3">üîì Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a</span>
            <button onclick="saveData()" class="btn btn-primary btn-sm fw-bold">L∆ØU L√äN CLOUD</button>
            <button onclick="lock()" class="btn btn-outline-secondary btn-sm">ƒê√≥ng</button>
        </div>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th width="5%">STT</th>
                <th width="15%">M√É M√ÅY</th>
                <th width="60%">T√äN H·ªÜ TH·ªêNG / THI·∫æT B·ªä X√âT NGHI·ªÜM</th>
                <th width="20%">S·ªê L∆Ø·ª¢NG TEST</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
        <tfoot>
            <tr class="fw-bold bg-light">
                <td colspan="3" class="text-end px-3">T·ªîNG C·ªòNG</td>
                <td id="totalValue" class="text-end text-danger fs-5 px-3">0</td>
            </tr>
        </tfoot>
    </table>

    <div class="signature-section">
        <div class="sig-box">
            <p class="fw-bold">Ng∆∞·ªùi l·∫≠p b·∫£ng</p>
            <br><br><br>
            <p>....................................</p>
        </div>
        <div class="sig-box">
            <p><i>Ng√†y ...... th√°ng ...... nƒÉm 20...</i></p>
            <p class="fw-bold">Tr∆∞·ªüng khoa X√©t nghi·ªám</p>
            <br><br><br>
            <p>....................................</p>
        </div>
    </div>
</div>

<script>
    // 1. C·∫§U H√åNH FIREBASE
    const firebaseConfig = {
        databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. BI·∫æN KH·ªûI T·∫†O
    const PASSWORD = "1"; 
    let isEditing = false;

    const machines = [
        { id: "PT100674", ten: "H·ªá th·ªëng x√©t nghi·ªám sinh h√≥a - mi·ªÖn d·ªãch t·ª± ƒë·ªông v√† thi·∫øt b·ªã h·ªó tr·ª£" },
        { id: "PT100673", ten: "M√°y ƒë·∫øm t·∫ø b√†o d√≤ng ch·∫£y (flow cytometry) (m√°y ph√¢n t√≠ch t·∫ø b√†o d√≤ng ch·∫£y)" },
        { id: "PT100661", ten: "M√°y ph√¢n t√≠ch huy·∫øt h·ªçc t·ª± ƒë·ªông ‚â• 50 th√¥ng s·ªë (m√°y ph√¢n t√≠ch huy·∫øt h·ªçc)" },
        { id: "PT100663", ten: "M√°y ph√¢n t√≠ch mi·ªÖn d·ªãch t·ª± ƒë·ªông ‚â• 150 test/gi·ªù (m√°y ph√¢n t√≠ch mi·ªÖn d·ªãch)" }
    ];

    // G√°n ng√†y hi·ªán t·∫°i cho √¥ ch·ªçn ng√†y
    document.getElementById('datePicker').valueAsDate = new Date();

    // 3. C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN
    function unlock() {
        const pass = document.getElementById('passInput').value;
        if(pass === PASSWORD) {
            isEditing = true;
            document.getElementById('authArea').style.display = "none";
            document.getElementById('editArea').style.display = "block";
            loadData(); // T·∫£i l·∫°i ƒë·ªÉ m·ªü kh√≥a c√°c √¥ input
        } else {
            alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
        }
    }

    function lock() {
        isEditing = false;
        document.getElementById('authArea').style.display = "block";
        document.getElementById('editArea').style.display = "none";
        document.getElementById('passInput').value = "";
        loadData(); // T·∫£i l·∫°i ƒë·ªÉ kh√≥a c√°c √¥ input
    }

    // 4. H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ª™ FIREBASE
    function loadData() {
        const date = document.getElementById('datePicker').value;
        if (!date) return;

        // Truy v·∫•n ƒë·∫øn n√∫t d·ªØ li·ªáu theo ng√†y
        const dataRef = database.ref('reports/' + date);

        dataRef.once('value', (snapshot) => {
            const dayData = snapshot.val() || {};
            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            let total = 0;

            machines.forEach((m, i) => {
                const val = dayData[m.id] || "";
                if(val) total += parseInt(val);

                let row = `<tr>
                    <td class="text-center">${i+1}</td>
                    <td class="text-center"><code>${m.id}</code></td>
                    <td class="px-3">${m.ten}</td>
                    <td>
                        <input type="number" 
                               ${!isEditing ? 'readonly' : ''} 
                               oninput="calculateTotal()" 
                               id="input-${m.id}" 
                               class="input-number" 
                               value="${val}" 
                               placeholder="0">
                    </td>
                </tr>`;
                body.innerHTML += row;
            });
            document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
        });
    }

    // 5. H√ÄM T√çNH T·ªîNG T·∫†M TH·ªúI KHI NH·∫¨P
    function calculateTotal() {
        let total = 0;
        machines.forEach(m => {
            const val = document.getElementById(`input-${m.id}`).value;
            if(val) total += parseInt(val);
        });
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    // 6. H√ÄM L∆ØU D·ªÆ LI·ªÜU L√äN FIREBASE
    function saveData() {
        const date = document.getElementById('datePicker').value;
        if (!date) {
            alert("Vui l√≤ng ch·ªçn ng√†y!");
            return;
        }

        const updateData = {};
        machines.forEach(m => {
            const val = document.getElementById(`input-${m.id}`).value;
            updateData[m.id] = val;
        });

        // ƒê·∫©y d·ªØ li·ªáu l√™n Firebase
        database.ref('reports/' + date).set(updateData)
            .then(() => {
                alert("ƒê√£ l∆∞u d·ªØ li·ªáu l√™n Cloud th√†nh c√¥ng!");
                lock();
            })
            .catch((error) => {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi Firebase: " + error.message);
            });
    }

    // Kh·ªüi ch·∫°y l·∫ßn ƒë·∫ßu
    loadData();
</script>

</body>
</html>
