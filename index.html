<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Thiết Bị - BV Ung Bướu CS2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { 
            background: #fff; 
            font-family: "Times New Roman", Times, serif; 
            padding: 20px; 
            color: #000;
        }

        .report-wrapper { 
            max-width: 900px; 
            margin: auto; 
            border: 1px solid #000;
            padding: 30px;
        }

        .hospital-header {
            border-bottom: 2px solid #000;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .report-title { 
            text-align: center; 
            font-size: 2.2rem; 
            font-weight: bold; 
            color: #b30000; 
            margin: 15px 0 5px 0; 
            text-transform: uppercase; 
        }

        /* Ô hiển thị người báo cáo */
        .reporter-box {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 25px;
            color: #333;
        }

        .main-table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 1.5px solid #000; 
        }

        .main-table th { 
            background: #f2f2f2; 
            border: 1px solid #000; 
            padding: 10px; 
            text-align: center; 
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .main-table td { 
            border: 1px solid #000; 
            padding: 8px; 
            vertical-align: middle; 
            font-size: 1.3rem; 
        }

        .input-num { 
            width: 100%; 
            border: none; 
            background: transparent; 
            text-align: center; 
            font-size: 1.6rem; 
            font-weight: bold; 
            outline: none; 
        }

        .input-num:focus { background: #fff9c4; }

        .calc-tool { 
            background: #fcfcfc; 
            border: 1px dashed #666; 
            padding: 15px; 
            margin-bottom: 20px; 
        }

        .mini-input { 
            width: 70px; 
            border: 1px solid #000; 
            text-align: center; 
            font-weight: bold; 
            padding: 5px; 
            margin: 2px; 
        }

        .btn-action {
            font-weight: bold;
            border: 1px solid #000;
            padding: 5px 15px;
        }
    </style>
</head>
<body>

<div class="report-wrapper">
    <div class="hospital-header d-flex justify-content-between align-items-end">
        <div>
            <div style="font-size: 1.4rem; font-weight: bold;">BỆNH VIỆN UNG BƯỚU - CS2</div>
            <div style="font-weight: bold; color: green;">KHOA XÉT NGHIỆM</div>
        </div>
        <div class="text-end" style="font-size: 0.9rem;">
            <b>Dữ Liệu Hiệu Suất Trực Tuyến</b><br>Năm 2026
        </div>
    </div>

    <h1 class="report-title">Báo Cáo Hiệu Suất Thiết Bị</h1>
    <div class="reporter-box">
        Người báo cáo: <span style="color: #004e92;">TRƯƠNG CÔNG HẬU</span>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <b>Ngày báo cáo:</b>
            <input type="text" id="datePicker" class="form-control text-center fw-bold" style="width:130px; border: 1px solid #000;">
        </div>
        <div>
            <div id="authArea" class="d-flex align-items-center border p-1">
                <small class="me-2">Quyền sửa:</small>
                <input type="password" id="passInput" style="border:none; outline:none; width:60px;" placeholder="***">
            </div>
            <div id="editArea" style="display:none">
                <button onclick="saveData()" id="btnSave" class="btn btn-danger btn-action">LƯU DỮ LIỆU</button>
                <button onclick="lock()" class="btn btn-secondary btn-action ms-2">ĐÓNG</button>
            </div>
        </div>
    </div>

    <div id="calcTool" class="calc-tool" style="display:none">
        <div class="fw-bold mb-2 small">● Bộ tính cộng dồn (Tự xóa số 0 khi click):</div>
        <div class="d-flex flex-wrap align-items-center">
            <input type="number" id="q1" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <input type="number" id="q2" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <input type="number" id="q3" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <input type="number" id="q4" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <input type="number" id="q5" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <input type="number" id="q6" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <input type="number" id="q7" class="mini-input q-input" oninput="doSum()" onfocus="if(this.value=='0')this.value=''">
            <span class="ms-3 fw-bold">Tổng phụ: <span id="res7" class="text-danger">0</span></span>
        </div>
    </div>

    <table class="main-table">
        <thead>
            <tr>
                <th width="8%">STT</th>
                <th>Tên Hệ Thống / Thiết Bị</th>
                <th width="20%">Model</th>
                <th width="22%">Số Lượng</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const machines = [
        { id: "PT100674", ten: "Hệ thống xét nghiệm sinh hóa - miễn dịch", model: "24d" },
        { id: "PT100673", ten: "Máy đếm tế bào dòng chảy (Flow)", model: "NAVIOS" },
        { id: "PT100661", ten: "Máy phân tích huyết học tự động", model: "DxH 800" },
        { id: "PT100663", ten: "Máy phân tích miễn dịch tự động", model: "DxI 800" }
    ];

    let lastDateKey = "";
    let isEditing = false;

    function init() {
        const now = new Date();
        lastDateKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

        flatpickr("#datePicker", {
            defaultDate: "today", 
            dateFormat: "d/m/Y",
            onChange: (sel) => {
                const d = sel[0];
                lastDateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                loadData();
            }
        });
        loadData();
    }

    function loadData() {
        db.ref('reports/' + lastDateKey).once('value', (s) => {
            const data = s.val() || {};
            
            let sQ = 0;
            for(let i=1; i<=7; i++) {
                const val = data['q'+i] || "";
                const el = document.getElementById('q'+i);
                if(el) el.value = val;
                if(val !== "") sQ += parseInt(val) || 0;
            }
            document.getElementById('res7').innerText = sQ;

            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            machines.forEach((m, i) => {
                const val = data[m.id] || 0;
                body.innerHTML += `
                    <tr>
                        <td class="text-center">${i+1}</td>
                        <td class="fw-bold px-2">${m.ten}</td>
                        <td class="text-center" style="color:#004e92">${m.model}</td>
                        <td>
                            <input type="number" id="val-${m.id}" class="input-num" 
                            value="${val}" ${!isEditing ? 'readonly' : ''} 
                            onfocus="if(this.value=='0')this.value=''">
                        </td>
                    </tr>`;
            });
        });
    }

    function doSum() {
        let s = 0;
        document.querySelectorAll('.q-input').forEach(i => {
            if(i.value !== "") s += parseInt(i.value) || 0;
        });
        document.getElementById('res7').innerText = s;
        const line1 = document.getElementById('val-PT100674');
        if(line1 && isEditing) { line1.value = s; }
    }

    document.getElementById('passInput').addEventListener('input', function() {
        if(this.value === "123") {
            isEditing = true;
            document.getElementById('authArea').style.display = "none";
            document.getElementById('editArea').style.display = "block";
            document.getElementById('calcTool').style.display = "block";
            this.value = "";
            loadData();
        }
    });

    function lock() {
        isEditing = false;
        document.getElementById('authArea').style.display = "flex";
        document.getElementById('editArea').style.display = "none";
        document.getElementById('calcTool').style.display = "none";
        document.getElementById('passInput').value = "";
        loadData();
    }

    function saveData() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.innerText = "ĐANG LƯU...";
        
        const update = {};
        machines.forEach(m => {
            const el = document.getElementById('val-' + m.id);
            update[m.id] = el ? (el.value || 0) : 0;
        });
        for(let i=1; i<=7; i++) update['q'+i] = document.getElementById('q'+i).value;

        db.ref('reports/' + lastDateKey).set(update).then(() => {
            alert("Dữ liệu đã được lưu trực tuyến thành công!");
            btn.disabled = false; btn.innerText = "LƯU DỮ LIỆU";
            lock();
        });
    }

    init();
</script>
</body>
</html>
