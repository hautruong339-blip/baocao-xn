<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o C√°o Hi·ªáu Su·∫•t - Xu√¢n B√≠nh Ng·ªç 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #b30000; --gold: #ffd700; }
        body { 
            background: #7a0000; font-family: "Times New Roman", Times, serif;
            padding: 40px 20px; background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
        }
        .ong-do-container {
            max-width: 850px; margin: auto; background: #fff; padding: 40px;
            border: 10px solid var(--gold); border-image: linear-gradient(to bottom right, #ffd700, #ff8c00, #ffd700) 1;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .title { text-align: center; color: var(--red); font-weight: bold; font-size: 2.2rem; margin-bottom: 25px; text-shadow: 1px 1px var(--gold); }
        .table { border: 2px solid var(--red); }
        .table thead th { background: var(--red); color: #fff; text-align: center; border: 1px solid var(--gold); }
        
        /* Input c·ª±c nh·∫π, kh√¥ng d√πng transition ƒë·ªÉ tr√°nh lag */
        .input-number { 
            width: 100%; border: none; text-align: center; font-size: 1.8rem; 
            font-weight: bold; color: var(--red); background: #fffcf0; outline: none;
        }
        .input-number:focus { background: #ffd70040; border-bottom: 2px solid var(--red); }
        .input-number[readonly] { background: transparent; }

        #passInput { width: 30px; border: none; background: transparent; color: transparent; outline: none; }
        .no-print { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        #save-status { font-weight: bold; font-size: 0.9rem; margin-left: 10px; }
    </style>
</head>
<body>

<div class="ong-do-container">
    <div class="header d-flex border-bottom border-danger pb-3 mb-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/03/Logo_BV_Ung_B%C6%B0%E1%BB%9Bu_TP.HCM.png" width="60" class="me-3">
        <div>
            <h5 class="m-0 text-danger fw-bold">B·ªÜNH VI·ªÜN UNG B∆Ø·ªöU - CS2</h5>
            <p class="m-0 text-secondary fw-bold small">üßß KHOA X√âT NGHI·ªÜM - 2026</p>
        </div>
    </div>

    <h1 class="title">B√ÅO C√ÅO HI·ªÜU SU·∫§T</h1>

    <div class="no-print">
        <div class="d-flex align-items-center gap-2">
            <b class="text-danger small">NG√ÄY:</b>
            <input type="text" id="datePicker" class="form-control form-control-sm text-center fw-bold" style="width:130px;">
        </div>
        <div class="d-flex align-items-center">
            <input type="password" id="passInput">
            <div id="editArea" style="display:none">
                <button onclick="saveData()" id="btnSave" class="btn btn-danger btn-sm fw-bold">L∆ØU B√ÅO C√ÅO</button>
                <button onclick="lock()" class="btn btn-outline-secondary btn-sm ms-2">ƒê√ìNG</button>
                <span id="save-status"></span>
            </div>
        </div>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th width="10%">STT</th>
                <th>T√™n Thi·∫øt B·ªã</th>
                <th width="25%">S·ªë L∆∞·ª£ng</th>
            </tr>
        </thead>
        <tbody>
            <tr><td class="text-center">1</td><td>Sinh h√≥a - Mi·ªÖn d·ªãch (24d)</td><td><input type="number" id="val-PT100674" class="input-number" readonly oninput="updateTotalOnly()"></td></tr>
            <tr><td class="text-center">2</td><td>M√°y ƒë·∫øm d√≤ng ch·∫£y (NAVIOS)</td><td><input type="number" id="val-PT100673" class="input-number" readonly oninput="updateTotalOnly()"></td></tr>
            <tr><td class="text-center">3</td><td>Huy·∫øt h·ªçc t·ª± ƒë·ªông (DxH 800)</td><td><input type="number" id="val-PT100661" class="input-number" readonly oninput="updateTotalOnly()"></td></tr>
            <tr><td class="text-center">4</td><td>Mi·ªÖn d·ªãch t·ª± ƒë·ªông (DxI 800)</td><td><input type="number" id="val-PT100663" class="input-number" readonly oninput="updateTotalOnly()"></td></tr>
        </tbody>
        <tfoot>
            <tr class="table-warning">
                <td colspan="2" class="text-end fw-bold text-danger">T·ªîNG:</td>
                <td id="totalValue" class="text-center fw-bold fs-3 text-danger">0</td>
            </tr>
        </tfoot>
    </table>
    <div class="text-end mt-2 fw-bold text-danger small">Ng√†y <span id="dDay">..</span>/<span id="dMonth">..</span>/2026</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    const firebaseConfig = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const machineIDs = ["PT100674", "PT100673", "PT100661", "PT100663"];
    let lastDateKey = "";

    // 1. KH·ªûI T·∫†O
    function init() {
        flatpickr("#datePicker", {
            defaultDate: "today", dateFormat: "d/m/Y",
            onChange: (dates) => {
                lastDateKey = dates[0].toISOString().split('T')[0];
                fetchDataOnce();
            }
        });
        lastDateKey = new Date().toISOString().split('T')[0];
        fetchDataOnce();
    }

    // 2. T·∫¢I D·ªÆ LI·ªÜU (Ch·ªâ g·ªçi 1 l·∫ßn khi ƒë·ªïi ng√†y)
    function fetchDataOnce() {
        const [y, m, d] = lastDateKey.split('-');
        document.getElementById('dDay').innerText = d;
        document.getElementById('dMonth').innerText = m;

        // D√πng .once ƒë·ªÉ l·∫•y xong l√† th√¥i, kh√¥ng gi·ªØ k·∫øt n·ªëi ƒë·ªìng b·ªô
        db.ref('reports/' + lastDateKey).once('value').then((s) => {
            const data = s.val() || {};
            machineIDs.forEach(id => {
                const el = document.getElementById('val-' + id);
                el.value = data[id] || 0;
            });
            updateTotalOnly();
        });
    }

    // 3. T√çNH T·ªîNG (Ch·ªâ ch·∫°y tr√™n m√°y n·ªôi b·ªô, kh√¥ng ƒë·ª•ng t·ªõi Firebase)
    function updateTotalOnly() {
        let total = 0;
        machineIDs.forEach(id => {
            total += parseInt(document.getElementById('val-' + id).value) || 0;
        });
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    // 4. M·ªû KH√ìA NH·∫¨P LI·ªÜU (Ho√†n to√†n Offline)
    function unlock() {
        document.getElementById('editArea').style.display = "block";
        machineIDs.forEach(id => {
            document.getElementById('val-' + id).removeAttribute('readonly');
        });
        document.getElementById('val-' + machineIDs[0]).focus();
    }

    function lock() {
        document.getElementById('editArea').style.display = "none";
        machineIDs.forEach(id => {
            document.getElementById('val-' + id).setAttribute('readonly', true);
        });
    }

    // 5. L∆ØU D·ªÆ LI·ªÜU (Ch·ªâ k·∫øt n·ªëi khi nh·∫•n n√∫t n√†y)
    function saveData() {
        const btn = document.getElementById('btnSave');
        const status = document.getElementById('save-status');
        
        btn.disabled = true;
        status.innerText = "‚åõ ƒêang l∆∞u...";
        status.style.color = "blue";

        const update = {};
        machineIDs.forEach(id => {
            update[id] = document.getElementById('val-' + id).value || 0;
        });

        // G·ª≠i d·ªØ li·ªáu l√™n Firebase
        db.ref('reports/' + lastDateKey).set(update)
            .then(() => {
                status.innerText = "‚úÖ ƒê√£ l∆∞u xong!";
                status.style.color = "green";
                setTimeout(() => { status.innerText = ""; btn.disabled = false; lock(); }, 1500);
            })
            .catch(e => {
                alert("L·ªói m·∫°ng: " + e.message);
                btn.disabled = false;
                status.innerText = "‚ùå L·ªói!";
            });
    }

    // Ph√≠m t·∫Øt Space ƒë·ªÉ nh·∫≠p
    document.getElementById('passInput').addEventListener('keydown', (e) => {
        if (e.code === "Space") { e.preventDefault(); unlock(); }
    });

    init();
</script>
</body>
</html>
