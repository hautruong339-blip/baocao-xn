<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o C√°o Hi·ªáu Su·∫•t - Xu√¢n B√≠nh Ng·ªç 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --red: #b30000; --gold: #ffd700; --dark-red: #7a0000; }
        body { 
            background: var(--dark-red); 
            font-family: "Times New Roman", Times, serif;
            padding: 80px 20px;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            overflow-x: hidden;
        }
        #blossom-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        .ong-do-container {
            position: relative; max-width: 1050px; margin: auto; background: #fff;
            padding: 50px; border: 10px solid var(--gold);
            border-image: linear-gradient(to bottom right, #ffd700, #ff8c00, #ffd700) 1;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Tr·∫°ng th√°i k·∫øt n·ªëi */
        #connection-status {
            position: fixed; top: 10px; right: 10px; padding: 5px 15px;
            border-radius: 20px; font-weight: bold; font-size: 0.9rem; z-index: 10000;
        }
        .online { background: #28a745; color: white; }
        .offline { background: #dc3545; color: white; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* C√°c th√†nh ph·∫ßn trang tr√≠ */
        .hinh-thoi {
            position: absolute; width: 80px; height: 80px; background: var(--red);
            border: 3px solid var(--gold); transform: rotate(45deg);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .hinh-thoi span { transform: rotate(-45deg); color: var(--gold); font-weight: bold; font-size: 1.1rem; }
        .top-l { top: -45px; left: -45px; } .top-r { top: -45px; right: -45px; }
        .bot-l { bottom: -45px; left: -45px; } .bot-r { bottom: -45px; right: -45px; }

        .title { text-align: center; color: var(--red); font-weight: bold; font-size: 2.5rem; text-shadow: 1px 1px var(--gold); margin: 20px 0; }
        .table { border: 2px solid var(--red); }
        .table thead th { background: var(--red); color: #fff; text-align: center; border: 1px solid var(--gold); }
        .input-number { width: 100%; border: none; text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--red); background: #fffcf0; }
        #passInput { width: 40px; border: none; background: transparent; cursor: default; }
    </style>
</head>
<body>

<div id="connection-status" class="offline">ƒêang ki·ªÉm tra k·∫øt n·ªëi...</div>
<canvas id="blossom-canvas"></canvas>

<div class="ong-do-container">
    <div class="hinh-thoi top-l"><span>CH√öC</span></div>
    <div class="hinh-thoi top-r"><span>M·ª™NG</span></div>
    <div class="hinh-thoi bot-l"><span>NƒÇM</span></div>
    <div class="hinh-thoi bot-r"><span>M·ªöI</span></div>

    <div class="header d-flex align-items-center border-bottom border-danger pb-3 mb-4">
        <img src="https://via.placeholder.com/100" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/0/03/Logo_BV_Ung_B%C6%B0%E1%BB%9Bu_TP.HCM.png'" width="100" class="me-3">
        <div>
            <h4 class="m-0 text-danger fw-bold">B·ªÜNH VI·ªÜN UNG B∆Ø·ªöU - CS2</h4>
            <h5 class="m-0 text-secondary">üßß KHOA X√âT NGHI·ªÜM - XU√ÇN B√çNH NG·ªå 2026</h5>
        </div>
    </div>

    <h1 class="title">B√ÅO C√ÅO HI·ªÜU SU·∫§T</h1>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <b>Ng√†y b√°o c√°o:</b>
            <input type="text" id="datePicker" class="form-control text-center fw-bold border-danger" style="width:150px;">
        </div>
        <div>
            <div id="authArea"><input type="password" id="passInput"></div>
            <div id="editArea" style="display:none">
                <button onclick="saveData()" class="btn btn-danger btn-sm px-4">L∆ØU D·ªÆ LI·ªÜU</button>
                <button onclick="lock()" class="btn btn-outline-secondary btn-sm">ƒê√ìNG</button>
            </div>
        </div>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th width="5%">STT</th>
                <th>T√™n H·ªá Th·ªëng / Thi·∫øt B·ªã</th>
                <th width="20%">Model</th>
                <th width="15%">S·ªë L∆∞·ª£ng</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr class="table-warning">
                <td colspan="3" class="text-end fw-bold text-danger">T·ªîNG C·ªòNG:</td>
                <td id="totalValue" class="text-center fw-bold fs-4 text-danger">0</td>
            </tr>
        </tfoot>
    </table>
    <div class="text-end mt-3 fw-bold text-danger">Ng√†y <span id="dDay">..</span> th√°ng <span id="dMonth">..</span> nƒÉm 2026</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>

<script>
    // 1. C·∫§U H√åNH FIREBASE (ƒê√£ c·∫≠p nh·∫≠t URL c·ªßa b·∫°n)
    const firebaseConfig = {
        databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. THEO D√ïI K·∫æT N·ªêI
    const statusDiv = document.getElementById('connection-status');
    database.ref(".info/connected").on("value", (snap) => {
        if (snap.val() === true) {
            statusDiv.innerText = "‚óè ƒê√£ k·∫øt n·ªëi Firebase";
            statusDiv.className = "online";
        } else {
            statusDiv.innerText = "‚óã M·∫•t k·∫øt n·ªëi server";
            statusDiv.className = "offline";
        }
    });

    // 3. KH·ªûI T·∫†O D·ªÆ LI·ªÜU M√ÅY M√ìC
    const machines = [
        { id: "PT100674", ten: "H·ªá th·ªëng x√©t nghi·ªám sinh h√≥a - mi·ªÖn d·ªãch", model: "24d" },
        { id: "PT100673", ten: "M√°y ƒë·∫øm t·∫ø b√†o d√≤ng ch·∫£y", model: "NAVIOS" },
        { id: "PT100661", ten: "M√°y ph√¢n t√≠ch huy·∫øt h·ªçc t·ª± ƒë·ªông", model: "DxH 800" },
        { id: "PT100663", ten: "M√°y ph√¢n t√≠ch mi·ªÖn d·ªãch t·ª± ƒë·ªông", model: "DxI 800" }
    ];

    let isEditing = false;
    let lastDateKey = "";
    let calendar;

    function init() {
        calendar = flatpickr("#datePicker", {
            locale: "vn", dateFormat: "d/m/Y", defaultDate: "today",
            onChange: (dates) => {
                lastDateKey = flatpickr.formatDate(dates[0], "Y-m-d");
                loadData(lastDateKey);
            }
        });
        lastDateKey = flatpickr.formatDate(new Date(), "Y-m-d");
        loadData(lastDateKey);
        animate();
    }

    function loadData(dateKey) {
        const [y, m, d] = dateKey.split('-');
        document.getElementById('dDay').innerText = d;
        document.getElementById('dMonth').innerText = m;
        
        database.ref('reports/' + dateKey).on('value', (s) => {
            renderTable(s.val() || {});
        });
    }

    function renderTable(data) {
        const body = document.getElementById('tableBody');
        body.innerHTML = "";
        machines.forEach((m, i) => {
            let val = data[m.id] || 0;
            body.innerHTML += `
                <tr>
                    <td class="text-center">${i+1}</td>
                    <td>${m.ten}</td>
                    <td class="text-center">${m.model}</td>
                    <td>
                        <input type="number" id="input-${i}" class="input-number" 
                        value="${val}" ${!isEditing ? 'readonly' : ''} 
                        oninput="calculateTotal()">
                    </td>
                </tr>`;
        });
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        machines.forEach((_, i) => {
            const v = document.getElementById('input-' + i).value;
            total += parseInt(v) || 0;
        });
        document.getElementById('totalValue').innerText = total.toLocaleString('vi-VN');
    }

    function saveData() {
        const data = {};
        machines.forEach((m, i) => {
            data[m.id] = document.getElementById('input-' + i).value || 0;
        });
        database.ref('reports/' + lastDateKey).set(data)
            .then(() => { alert("L∆∞u th√†nh c√¥ng!"); lock(); })
            .catch((e) => alert("L·ªói: " + e.message));
    }

    // M·∫≠t m√£ m·ªü kh√≥a: Nh·∫•n ph√≠m C√°ch (Space) khi ƒëang ·ªü √¥ m·∫≠t kh·∫©u (ƒë·ªÉ tr·ªëng)
    function unlock() { isEditing = true; document.getElementById('authArea').style.display="none"; document.getElementById('editArea').style.display="block"; loadData(lastDateKey); }
    function lock() { isEditing = false; document.getElementById('authArea').style.display="block"; document.getElementById('editArea').style.display="none"; loadData(lastDateKey); }
    
    document.getElementById('passInput').addEventListener('keydown', (e) => {
        if (e.code === "Space") { e.preventDefault(); unlock(); }
    });

    // Hi·ªáu ·ª©ng hoa r∆°i (gi·∫£n l∆∞·ª£c)
    const canvas = document.getElementById('blossom-canvas');
    const ctx = canvas.getContext('2d');
    let petals = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    class Petal {
        constructor() { this.x = Math.random()*canvas.width; this.y = Math.random()*canvas.height; this.s = Math.random()*5+2; this.v = Math.random()*2+1; }
        draw() { ctx.fillStyle = "#FFD700"; ctx.beginPath(); ctx.arc(this.x, this.y, this.s, 0, Math.PI*2); ctx.fill(); }
        update() { this.y += this.v; if(this.y > canvas.height) this.y = -10; }
    }
    for(let i=0; i<30; i++) petals.push(new Petal());
    function animate() { ctx.clearRect(0,0,canvas.width, canvas.height); petals.forEach(p=>{p.update(); p.draw();}); requestAnimationFrame(animate); }

    init();
</script>
</body>
</html>
